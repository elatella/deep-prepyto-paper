## Results

In view of the effort required for the manual segmentation of SVs, we decided to develop an automatic segmentation procedure.
Since we had previously manually segmented a number of tomograms with the program IMOD, we could use these segmentations as the ground truth [@doi:10.1006/jsbi.1996.0013].
We trained a U-Net with a set of 9 segmented tomograms of rat synaptosomes (see Materials and Methods).

We seeked to further improve segmentation accuracy by feeding the probability mask output by the U-Net to a series of postprocessing steps (Figure {@fig:pipeline}).
Three sets of tomograms were used to assess the performance of the pipeline:

1) Traning dataset: The 9 rat synaptosome tomograms that had been used for U-Net training

2) Testing dataset: Another 9 rat synaptosome tomograms

3) Testing dataset for generalizability: 12 mouse astrocytic and primary neuronal culture tomograms). 

Each tomogram was split into patches of 32^3^ voxels.
These patches were fed in the U-Net, which outputs a probability mask for those patches.
To obtain a complete probability mask, the patches are stitched back together.
The probability mask was binarized first with a global threshold value and then with an adaptative localized thresholding steps (Figure {@fig:pipeline}, Figure {@fig:tom}).

![**Pipeline of automatic segmentation.** a) Tomograms b) Splitting in 3D patches c) Segmentation Network/ trained U-Net d) probability masks e) stitching patches back together f) thresholding h) radial profile i) outlier removal j)Segmented Vesicles](images/pipeline_new.png){#fig:pipeline width="20cm"}

While a global threshold serves as an initial step in vesicle segmentation, it often falls short in complex scenarios, especially when vesicles are in close proximity or exhibit overlap. To enhance the segmentation accuracy in such cases, we employ an adaptive thresholding methodology that capitalizes on the probability mask generated by our deep learning architecture.

#### Initial Segmentation and Thresholding:
The segmentation journey commences with the alignment of the image with its associated deep labels and the probability mask. To ensure a comprehensive segmentation, the probability mask's edges are meticulously cropped, safeguarding against inadvertent truncation of boundary-residing vesicles. An optimal threshold, derived from the image and the probability mask, undergoes fine-tuning through a coefficient adjustment. This refined threshold then serves to binarize the mask, with connected components subsequently labeled, delineating individual vesicles.

#### Collision Resolution through Adaptive Thresholding:
In scenarios where vesicles are densely packed, collisions become a challenge, often leading to the amalgamation of multiple vesicles into a singular segmented entity. Addressing this, potential collision vesicles are pinpointed based on specific geometric attributes, such as their extent and area z-score. For each vesicle identified under this criterion, a localized region surrounding the vesicle is extracted. This region is then subjected to a masking process, ensuring focus remains solely on the vesicle in question.

The essence of collision resolution revolves around the iterative modulation of the threshold to attain a more granular segmentation. Commencing from the established threshold, it's progressively augmented until the connected components within the localized region amplify, signaling a potential vesicle separation. This adaptive modulation persists until a threshold is identified that adeptly segregates the vesicles or until a set precision threshold is attained.

#### Expansion and Removal of Minuscule Vesicles:
Post-segmentation, certain vesicles might be represented as notably smaller than anticipated. To address this, an expansion strategy is employed, iteratively lowering the threshold to encapsulate more of the vesicle's structure. If expansion fails to achieve the desired size, these diminutive vesicles are removed, ensuring the final segmentation remains representative of genuine vesicle structures.
In conclusion, our adaptive thresholding technique, combined with collision resolution, ensures a more accurate and refined segmentation of vesicles in cryo-ET data. This approach capitalizes on the rich information present in the probability mask, providing a robust solution to the challenges posed by closely packed vesicles.



`\_more detail about global and adaptive localized threshold*`{.green}
For further optimization of the mask, outliers were removed. 
Removed outliers mostly consisted of vesicles that were only partially segmented, and vesicles which maks were adjacent due to proximity.
The removed masks, which only partially traced the vesicles, were reevaluated by reducing or expanding their radius (Figure {@fig:radial_profile}).
`\_was the center of the vesicles also reevaluated?*`{.green} `\_It's not clear or might be a false sentence we didn't remove or re-evaluate the mask?*`{.green}

![**A 2D slice of an automatically segmented dataset**. A) A section through a presynaptic terminal in a neuron tomogram. B) Predicted probability mask restricted to the segmentation region.  Purple corresponds to a low SV probability and yellow to a high SV probability. C) Instance mask of the vesicles after post-processing.](images/tomo-sclae.svg){#fig:tom width="15cm"}

#### Radial Prfile and Outlier Removal:
Each segmented vesicle undergoes a radial profile refinement. Representing vesicles as spheres, their position and radius are iteratively adjusted to mirror their actual structure in the tomogram. By computing the radial average and updating the vesicle's radius, this method ensures the segmented vesicles are a true representation of their form in the tomogram.

The radial profile serves as a pivotal tool in refining the segmentation of vesicles. By analyzing the radial distribution of intensity around the vesicle's centroid, we can discern the vesicle's true boundary. This method ensures that the segmented vesicles closely match their actual structure in the tomogram by iteratively adjusting their position and radius. The radial average is computed, and the vehicle's radius is updated based on the radial distance of the vesicle membrane's center and its thickness. This iterative refinement continues until the vesicle's representation aligns with its true structure.

![**Vesicle radius and position through the radial profile and cross-correlation** Radial Profile Refinement A) a couple of vesicles are not centered B) Radial Profile. The blue range is from the membrane center to the outer white halo center, this is the search range for the optimal radius. (smoothed by Gaussian filtering) C) second derivative of radial profile E, F, H, G) Same as above columns after refinement](images/radial_avg_115-099.svg){#fig:radial_profile width="15cm"}

The adjacent vesicle masks were separated (Figure `\_missing*`{.green}). `\_how?*`{.green}

`\_**missing Figure- Splitting adjacent vesicles. A) Examples of tomogram, no labels; B) raw label with connected vesicle-labels; C) modified label with separated vesicles ---> for software: IMOD**`{.green}

The Dice coefficient was used to track the global congruence between the manually segmented mask and the predicted mask within the different tomograms (Figure {@fig:dice-improv}).
To quantitatively assess the accuracy of our segmentation approach, we employed the Dice coefficient. This metric gauges the similarity between the manually annotated vesicle masks and the masks predicted by our model.
A higher Dice coefficient indicates a closer match between the manual and predicted segmentations, providing a measure of the model's performance.
The results, visualized in Figure {@fig:dice-improv}, showcase the global congruence across different tomograms, highlighting the efficacy of our segmentation pipeline.

![**Dice development during post-processing** Dice development at different post-processing steps of initial predicted mask (different colors correspond to different tomograms): A) synaptosomal training datasets B) synaptosomal test datasets c) neuron test datasets](images/improvment-post-processing-dice.svg){#fig:dice-improv width="15cm"}



| **_Dataset_** | **_Mask Dice_** | **_Final Label Dice_** | **_δ d_** | **_Δ c (nm)_** | **_Number of Vesicles_**  |  **_TP_**  |  **_FN_**  | **_FP_**  |
|---------------|:---------------:|:----------------------:| :-------: | :------------: |:-------------------------:|:----------:|:----------:|:---------:|
| SC 1          |      0.44       |          0.73          |   0.07    |   2.55±1.56    |            223            |    198     |     26     |    49     |
| SC 2          |       0.8       |          0.9           |   0.05    |   2.12±1.06    |            105            |    103     |     2      |     1     |
| SC 3          |      0.67       |          0.9           |   0.05    |   1.86±1.24    |            128            |    127     |     1      |     6     |
| SC 4          |      0.62       |          0.89          |   0.03    |   1.78±0.92    |            144            |    141     |     3      |     4     |
| SC 5          |      0.58       |          0.87          |   0.04    |   1.86±1.00    |            214            |    209     |     5      |    13     |
| SC 6          |      0.56       |          0.84          |   0.04    |   1.92±1.05    |            104            |    102     |     2      |    16     |
| SC 7          |      0.78       |          0.88          |   0.06    |   1.86±0.90    |            184            |    184     |     0      |    16     |
| SC 8          |      0.75       |          0.9           |   0.05    |   1.70±0.93    |            132            |    126     |     6      |     1     |
| SC 9          |      0.59       |          0.87          |   0.05    |   1.87±0.91    |            135            |    132     |     3      |    14     |
| **Average**   |  **0.64±0.11**  |     **0.86±0.05**      | **0.05**  | **1.95±1.08**  |        **152.22**         | **97.00%** | **3.00%**  | **7.30%** |
Table: Evaluation of the segmentation on the synaptosome train set. Mask Dice: Mask Dice coefficient for the predicted mask; Final Label Dice: Dice coefficient after post-processing; δ d: diameter error on correctly detected vesicle; Δ c: average error center (nm); Number of Vesicles: number of expected vesicles; TP: True Positive; FN: False Negative; FP: False Positive
{#tbl:train-tomograms}


| **_Dataset_** | **_Mask Dice_** | **_Final Label Dice_** | **_δ d_** | **_Δ c (nm)_** | **_Number of Vesicles_**  |  **_TP_**  | **_FN_**  | **_FP_**  |
|---------------|:---------------:|:----------------------:| :-------: | :------------: |:-------------------------:|:----------:|:---------:|:---------:|
| SC 10         |      0.75       |          0.88          |   0.07    |   1.86±1.18    |            129            |    123     |     6     |     5     |
| ST 1          |      0.75       |          0.83          |   0.11    |   2.66±1.52    |            699            |    687     |    12     |    33     |
| ST 2          |      0.74       |          0.77          |   0.11    |   2.27±1.84    |            122            |    117     |     5     |     2     |
| ST 3          |      0.72       |          0.74          |   0.11    |   3.64±2.22    |            434            |    397     |    37     |    57     |
| ST 5          |      0.77       |          0.85          |   0.08    |   2.20±1.26    |            535            |    526     |     9     |    25     |
| ST 6          |       0.6       |          0.83          |   0.07    |   2.02±1.12    |            373            |    353     |    20     |    42     |
| ST 7          |       0.8       |          0.83          |   0.06    |   2.22±1.14    |            110            |    107     |     3     |     9     |
| ST 8          |      0.83       |          0.91          |   0.04    |   2.09±1.04    |            100            |     99     |     1     |     2     |
| ST 10         |      0.77       |          0.86          |   0.05    |   1.96±1.04    |            77             |     74     |     3     |     6     |
| **Average**   |  **0.75±0.06**  |     **0.83±0.05**      | **0.08**  | **2.32±1.43**  |        **286.56**         | **96.30%** | **3.70%** | **6.10%** |
Table: Evaluation of the segmentation on the synaptosome test set (same sample type as the train set). For the meaning of the columns, see Table @tbl:train-tomograms.
{#tbl:test-tomograms}

| **_Dataset_** | **_Mask Dice_** | **_Final Label Dice_** | **_δ d_** | **_Δ c (nm)_** | **_Number of Vesicles_**  |  **_TP_**  |  **_FN_**  | **_FP_**  |
|---------------|:---------------:|:----------------------:| :-------: | :------------: |:-------------------------:|:----------:|:----------:|:---------:|
| N 133         |      0.76       |          0.86          |   0.05    |   2.16±1.32    |            523            |    467     |     56     |     8     |
| N 123         |      0.64       |          0.71          |   0.05    |   2.05±1.18    |            66             |     58     |     8      |     2     |
| N 84          |      0.86       |          0.89          |   0.06    |   1.44±0.75    |            498            |    484     |     14     |     1     |
| N 134         |      0.56       |          0.67          |   0.09    |   2.87±2.50    |            638            |    384     |    254     |    63     |
| N 115         |      0.57       |          0.63          |   0.08    |   3.56±3.23    |            170            |    123     |     47     |    32     |
| N 102         |      0.73       |          0.86          |   0.05    |   1.47±0.79    |            103            |     86     |     17     |     1     |
| N 80          |       0.7       |          0.81          |   0.07    |   2.67±2.00    |            111            |    102     |     9      |     3     |
| N 114         |      0.65       |          0.73          |   0.07    |   2.68±1.79    |            131            |     93     |     38     |     9     |
| N 132         |      0.69       |          0.87          |   0.03    |   1.65±1.26    |            135            |    129     |     6      |    32     |
| N 73          |      0.78       |          0.83          |   0.06    |   2.93±2.00    |            526            |    483     |     43     |     2     |
| N 128         |      0.67       |          0.85          |   0.04    |   2.33±1.70    |            252            |    232     |     20     |    19     |
| N 116         |      0.62       |          0.73          |   0.07    |   2.38±1.82    |            296            |    207     |     89     |    35     |
| **Average**   |  **0.69±0.09**  |     **0.79±0.09**      | **0.06**  | **2.35±1.83**  |        **287.42**         | **83.60%** | **16.40%** | **7.90%** |
Table: Evaluation of the segmentation on the neuron test set (different sample type as the train set). For the meaning of the columns, see Table @tbl:train-tomograms.
{#tbl:neuron-tomograms}

Our method transfers well across datasets even without fine-tuning which shows robustness and generalization.

### Comparison of manual segmentation with automatic deep-learning based segmentation

In the realm of cryo-electron tomography (cryoET), accurate segmentation of synaptic structures is paramount for understanding their spatial organization and function.
Traditional manual segmentation, while precise, is time-consuming and often limited in scope.
The advent of deep learning-based segmentation offers a promising alternative, providing both speed and scalability.

The traditional approach to manual segmentation in cryoET studies often restricted analyses to specific distances from the active zone, typically up to 250 nm.
This limitation inherently narrows the scope of synaptic or neuronal analyses.
However, with the integration of deep learning-based segmentation, it's now feasible to analyze entire synaptosomes or neurons comprehensively.
Not only does this method expedite the segmentation process, but it also enhances the accuracy and breadth of the analysis.
Furthermore, interactive tools like Napari significantly augment this process, allowing researchers to swiftly rectify false positives and negatives by adding or removing vesicles as needed, ensuring the highest level of accuracy in the final segmented output.

![**A: A 3D box representation of a synaptosome, visualized in an orthogonal view. The image showcases the intricate details of the structure with a scale bar indicating 100 nm.B: A probability map derived from the 3D U-Net segmentation. The map is presented schematically, with a color gradient ranging from blue (0.9968) to red (1), indicating the likelihood of synaptic vesicle presence.C: A tomogram post optimal global thresholding. This image provides a detailed view of the segmented structures, highlighting the precision of the automated segmentation process.D: The final representation of synaptic vesicle segmentation post-processing. Synaptic vesicles are depicted in light blue, overlaid on the ground truth obtained from expert annotations. The active zone is distinctly marked in red. The scale bar for this image is also set at 100 nm.** ](images/synaptasom-new.png){#fig:pipelineontomo width="15cm"}


#!#[**3D model of manual segmented and automatically segmented synaptosome.**](images/3d.png){#fig:3d width="10cm"}


###  Hierarchical connectivity segmentation of presynaptic terminals
Pyto is a software package designed to analyze pleomorphic membrane-bound molecular complexes in 3D images, particularly in the context of cryo-electron tomograms of neuronal synapses. A key feature of Pyto is its ability to accurately segment connectors and tethers within the pre-synaptic terminal, a task that requires a high level of precision. This segmentation process is hierarchical and connectivity-based, detecting densities interconnecting vesicles (connectors) and densities connecting vesicles to the active-zone plasma membrane (tethers).

In the study of synaptic vesicles regulation, the precision of segmentation is crucial. Accurate segmentation of connectors and tethers is essential as these structures play a significant role in the regulation of synaptic vesicles. Software that segments subcellular compartments, such as Pyto, provides a valuable tool in this process.

We have developed software that is designed to be compatible with programs like Pyto. This compatibility allows us to extract more detailed information from Cryo-Electron Tomography (Cryo-ET), even in densely populated in situ conditions. By using our software in conjunction with programs like Pyto, we can gain a deeper understanding of synaptic vesicles regulation. Importantly, our software aims to eliminate the need for manual segmentation, enhancing the efficiency and accuracy of the process.

![**3D Model of Cultured Mouse Neuron: Left - Tomogram; Left Center - Schematic segmentation with cell outline (light blue), mitochondria (dark blue), lysosomes (green), microtubules (dark magenta); Right Center - Vesicles segmented using VesPy and connectors via Pyto; Right - 3D representation of vesicles in the presynaptic terminal..**](images/amira_all.png){#fig:amira width="15cm"}
